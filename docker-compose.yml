version: '3.8'

services:
  bot:
    image: ${BOT_IMAGE:-ghcr.io/higrub89/the_chassis:latest}
    container_name: solana_trading_bot
    # Cambiado a 'always' para asegurar que el motor nunca se detenga en GCP
    restart: always
    
    # üèéÔ∏è ELIMINACI√ìN DE LATENCIA DE RED
    # El modo host permite al bot leer paquetes UDP de Helius/Solana directamente
    network_mode: "host" 
    
    # üõ°Ô∏è CAPACIDADES DE TIEMPO REAL
    cap_add:
      - SYS_NICE         # Para cambiar la prioridad del proceso (SCHED_FIFO)
      - IPC_LOCK         # Para el mlockall() que pusimos en Rust
    
    # üîì DESBLOQUEO DE V√ÅLVULAS (L√≠mites)
    ulimits:
      rtprio: 99         # M√°xima prioridad RT permitida
      memlock: -1        # Memoria bloqueada ilimitada para evitar swap
      nofile:
        soft: 65535      # Para manejar m√∫ltiples conexiones RPC simult√°neas
        hard: 65535

    env_file:
      - .env
    environment:
      - RUST_LOG=info
      - TZ=UTC
    volumes:
      - ./logs:/app/logs
      - ./settings.json:/app/settings.json
      - ./trading_state.db:/app/trading_state.db
      - ./pools_cache.json:/app/pools_cache.json

    # ‚ö†Ô∏è REVISI√ìN DE DEPLOY
    # He eliminado los l√≠mites de CPU estrictos para evitar el throttling del kernel.
    # En trading de baja latencia, preferimos que el bot use lo que necesite cuando lo necesite.
    deploy:
      resources:
        reservations:
          cpus: '1.0'
          memory: 1024M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"   # Reducido para evitar overhead de I/O en logs pesados
        max-file: "3"

    healthcheck:
      test: ["CMD-SHELL", "pidof the_chassis_app || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
