name: ğŸš€ Deploy Bot to GCP

on:
  push:
    branches: [ master ]
    paths:
      - 'core/**'
      - 'intelligence/**'
      - 'settings.json'
      - 'docker-compose.yml'
      - 'Dockerfile'
      - '.github/workflows/deploy.yml'
      - 'Cargo.toml'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Motivo del deploy manual'
        required: false
        default: 'Deploy manual'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/the_chassis

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: Detectar tipo de cambio
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  detect:
    name: ğŸ” Detectar Cambios
    runs-on: ubuntu-latest
    outputs:
      code_changed: ${{ steps.filter.outputs.code }}
      config_changed: ${{ steps.filter.outputs.config }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Filtrar cambios
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'core/**'
              - 'intelligence/**'
              - 'Cargo.toml'
              - 'Dockerfile'
              - '.github/workflows/**'
            config:
              - 'settings.json'
              - 'docker-compose.yml'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: Build y Push imagen (solo si hay cambios de cÃ³digo)
  # Se ejecuta en GitHub Actions â€” sin timeout en el servidor
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ğŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.code_changed == 'true'
    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Instalar dependencias del sistema (para cargo check)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y protobuf-compiler libprotobuf-dev libssl-dev pkg-config

      - name: ğŸ¦€ Instalar Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: âœ… Verificar compilaciÃ³n (cargo check)
        run: cargo check --workspace --release

      - name: ğŸ” Login a GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Extraer metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=sha-,format=short

      - name: âš¡ Configurar Docker Buildx (con cachÃ©)
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build y Push imagen a GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: Deploy al servidor GCP
  # El servidor SOLO hace pull + restart (sin compilar)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: ğŸš€ Deploy a GCP
    runs-on: ubuntu-latest
    needs: [detect, build]
    # Ejecutar si: build terminÃ³ OK (code change) O si solo hay config change
    if: |
      always() &&
      (needs.build.result == 'success' || needs.build.result == 'skipped') &&
      (needs.detect.outputs.code_changed == 'true' || needs.detect.outputs.config_changed == 'true')

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Configurar clave SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.GCP_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ Sincronizar archivos de configuraciÃ³n al servidor
        run: |
          rsync -avz \
            --exclude='.git' \
            --exclude='target/' \
            --exclude='logs/' \
            --exclude='trading_state.db' \
            --exclude='.env' \
            --exclude='*.bak' \
            --exclude='core/' \
            --exclude='intelligence/' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.GCP_USER }}@${{ secrets.GCP_SERVER_IP }}:~/bot_trading/

      - name: ğŸ”„ Deploy en servidor (pull imagen + restart)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_SERVER_IP }}
          username: ${{ secrets.GCP_USER }}
          key: ${{ secrets.GCP_SSH_KEY }}
          timeout: 5m
          script: |
            set -e
            cd ~/bot_trading

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸï¸  THE CHASSIS â€” Deploy AutomÃ¡tico"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“… Fecha: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "ğŸ“ Commit: ${{ github.sha }}"
            echo "ğŸ‘¤ Autor:  ${{ github.actor }}"

            # Login a GHCR para hacer pull
            echo "${{ secrets.GITHUB_TOKEN }}" | sudo docker login ghcr.io \
              -u ${{ github.actor }} --password-stdin

            if [ "${{ needs.detect.outputs.code_changed }}" == "true" ]; then
              echo "ğŸ³ CAMBIO EN CÃ“DIGO: Descargando nueva imagen de GHCR..."
              sudo docker pull ghcr.io/${{ env.IMAGE_NAME }}:latest

              # Actualizar docker-compose para usar imagen pre-compilada
              echo "ğŸ”„ Reiniciando con la nueva imagen..."
              sudo docker compose down
              sudo docker compose up -d
            else
              echo "ğŸ“‚ SOLO CONFIG: Reinicio rÃ¡pido (sin pull)..."
              sudo docker compose up -d
              sudo docker compose restart bot
            fi

            echo "â³ Esperando arranque (15s)..."
            sleep 15

            echo "ğŸ“‹ Logs de inicio:"
            sudo docker compose logs --tail=25

            echo ""
            echo "âœ… Deploy completado en segundos!"

      - name: ğŸ“± Notificar en Telegram
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="âœ…"
            MSG="Deploy exitoso"
          else
            EMOJI="âŒ"
            MSG="Deploy FALLIDO"
          fi

          CODE_CHANGED="${{ needs.detect.outputs.code_changed }}"
          if [ "$CODE_CHANGED" = "true" ]; then
            DEPLOY_TYPE="ğŸ³ Nueva imagen compilada"
          else
            DEPLOY_TYPE="âš¡ Zero-Build (solo config)"
          fi

          COMMIT_MSG="${{ github.event.head_commit.message }}"
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"

          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="<b>${EMOJI} THE CHASSIS â€” ${MSG}</b>
          <b>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</b>
          <b>â¬¡ Commit:</b> <code>${SHORT_SHA}</code>
          <b>â¬¡ Tipo:</b> ${DEPLOY_TYPE}
          <b>â¬¡ Mensaje:</b> ${COMMIT_MSG}
          <b>â¬¡ Autor:</b> ${{ github.actor }}

          <i>ğŸ¤– Bot actualizado y corriendo 24/7</i>"
