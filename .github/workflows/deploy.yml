name: ğŸš€ Deploy Bot to GCP (Institutional Grade)

on:
  push:
    branches: [ master ]
    paths:
      - 'core/**'
      - 'intelligence/**'
      - 'settings.json'
      - 'docker-compose.yml'
      - 'Dockerfile'
      - '.github/workflows/deploy.yml'
      - 'Cargo.toml'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Motivo del deploy manual'
        required: false
        default: 'CalibraciÃ³n manual'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/the_chassis

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: ECU - DetecciÃ³n QuirÃºrgica de Cambios
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  detect:
    name: ğŸ” Detectar Cambios
    runs-on: ubuntu-latest
    outputs:
      code_changed: ${{ steps.filter.outputs.code }}
      config_changed: ${{ steps.filter.outputs.config }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Filtrar cambios
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'core/**'
              - 'intelligence/**'
              - 'Cargo.toml'
              - 'Dockerfile'
              - '.github/workflows/**'
            config:
              - 'settings.json'
              - 'docker-compose.yml'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: CompilaciÃ³n y Ensamblaje en Pit-Lane
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ğŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.code_changed == 'true'
    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Instalar dependencias del sistema
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y protobuf-compiler libprotobuf-dev libssl-dev pkg-config

      - name: ğŸ¦€ Instalar Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ Cache Cargo (OptimizaciÃ³n TÃ©rmica)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: âœ… Verificar integridad estructural (Fail-Fast)
        run: cargo check --workspace --release

      - name: ğŸ” Login a GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Extraer metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=sha-,format=short

      - name: âš¡ Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build y Push a GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: InyecciÃ³n en Bare-Metal (Zero-Downtime)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: ğŸš€ Deploy a ProducciÃ³n
    runs-on: ubuntu-latest
    needs: [detect, build]
    if: |
      always() &&
      (needs.build.result == 'success' || needs.build.result == 'skipped') &&
      (needs.detect.outputs.code_changed == 'true' || needs.detect.outputs.config_changed == 'true')

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Configurar clave SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.GCP_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ Sincronizar telemetrÃ­a (Rsync estricto)
        run: |
          rsync -avz \
            --exclude='.git' \
            --exclude='target/' \
            --exclude='logs/' \
            --exclude='trading_state.db' \
            --exclude='.env' \
            --exclude='*.bak' \
            --exclude='core/' \
            --exclude='intelligence/' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.GCP_USER }}@${{ secrets.GCP_SERVER_IP }}:~/bot_trading/

      - name: ğŸ”„ EjecuciÃ³n de Despliegue CrÃ­tico (con Rollback)
        uses: appleboy/ssh-action@v1.0.3
        env:
          # InyecciÃ³n de secretos cifrados vÃ­a entorno, no en el comando
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ACTOR: ${{ github.actor }}
          IMAGE: ghcr.io/${{ env.IMAGE_NAME }}
          CODE_CHANGED: ${{ needs.detect.outputs.code_changed }}
          COMMIT_SHA: ${{ github.sha }}
        with:
          host: ${{ secrets.GCP_SERVER_IP }}
          username: ${{ secrets.GCP_USER }}
          key: ${{ secrets.GCP_SSH_KEY }}
          timeout: 5m
          envs: GH_TOKEN,ACTOR,IMAGE,CODE_CHANGED,COMMIT_SHA
          script: |
            set -e
            cd ~/bot_trading

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸï¸  THE CHASSIS â€” Despliegue Institucional"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Login seguro (el token no se expone en ps aux)
            echo "$GH_TOKEN" | sudo docker login ghcr.io -u "$ACTOR" --password-stdin

            if [ "$CODE_CHANGED" == "true" ]; then
              echo "ğŸ³ Descargando nueva imagen de GHCR..."
              
              # 1. Crear punto de restauraciÃ³n del motor actual
              sudo docker tag $IMAGE:latest $IMAGE:rollback || true
              
              # 2. Descargar la nueva compilaciÃ³n
              sudo docker pull $IMAGE:latest

              # 3. SustituciÃ³n sin desconexiÃ³n (Zero-Downtime Recreate)
              echo "âš¡ Realizando hot-swap del contenedor..."
              sudo docker compose up -d --no-deps --build bot
              
              # 4. TelemetrÃ­a de arranque
              echo "â³ Evaluando estabilidad del motor (15s)..."
              sleep 15
              
              # 5. Healthcheck y Rollback AutomÃ¡tico
              STATUS=$(sudo docker inspect -f '{{.State.Status}}' bot)
              if [ "$STATUS" != "running" ]; then
                echo "ğŸ’¥ ALERTA CRÃTICA: Falla de encendido detectada."
                echo "ğŸ”„ Iniciando protocolo ROLLBACK inmediato..."
                
                sudo docker tag $IMAGE:rollback $IMAGE:latest
                sudo docker compose up -d --no-deps bot
                
                echo "âŒ Despliegue abortado. Motor restaurado a la versiÃ³n previa."
                exit 1 # Forzar fallo en Actions para notificar en Telegram
              fi
            else
              echo "ğŸ“‚ MODO CALIBRACIÃ“N: Aplicando configuraciÃ³n en caliente..."
              sudo docker compose up -d
              sudo docker compose restart bot
            fi

            echo "âœ… IngenierÃ­a acoplada con Ã©xito."

      - name: ğŸ“± NotificaciÃ³n a Centro de Mando (Telegram)
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="ğŸŸ¢"
            MSG="DESPLIEGUE EXITOSO"
          else
            EMOJI="ğŸ”´"
            MSG="FALLO EN DESPLIEGUE / ROLLBACK EJECUTADO"
          fi

          CODE_CHANGED="${{ needs.detect.outputs.code_changed }}"
          if [ "$CODE_CHANGED" = "true" ]; then
            DEPLOY_TYPE="ğŸ³ InyecciÃ³n de Nuevo Binario (C/Rust)"
          else
            DEPLOY_TYPE="âš¡ CalibraciÃ³n de ECU (ConfiguraciÃ³n)"
          fi

          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"

          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="<b>${EMOJI} THE CHASSIS â€” ${MSG}</b>
          <b>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</b>
          <b>â¬¡ Commit:</b> <code>${SHORT_SHA}</code>
          <b>â¬¡ Tipo:</b> ${DEPLOY_TYPE}
          <b>â¬¡ Autor:</b> ${{ github.actor }}

          <i>Sistema operando bajo estÃ¡ndares de excelencia.</i>"