name: ğŸš€ Deploy Bot to GCP

on:
  push:
    branches: [ master ]
    paths:
      # Solo se activa si cambian archivos relevantes
      - 'core/**'
      - 'targets.json'
      - 'docker-compose.yml'
      - 'Dockerfile'
      - '.github/workflows/deploy.yml'
  # Permite lanzar el deploy manualmente desde GitHub
  workflow_dispatch:
    inputs:
      reason:
        description: 'Motivo del deploy manual'
        required: false
        default: 'Deploy manual'

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: VerificaciÃ³n del CÃ³digo (CI)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  verify:
    name: âœ… Verificar CÃ³digo Rust
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ¦€ Instalar Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: ğŸ“¦ Cache de dependencias Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: ğŸ”§ Instalar dependencias del sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libprotobuf-dev libssl-dev pkg-config

      - name: ğŸ” Verificar compilaciÃ³n (cargo check)
        run: cargo check --workspace --release

      - name: ğŸ“‹ Lints (cargo clippy)
        run: cargo clippy --workspace -- -D warnings
        continue-on-error: true  # Warnings no bloquean el deploy

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: Deploy al Servidor GCP
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: ğŸš€ Deploy a GCP
    runs-on: ubuntu-latest
    needs: verify  # Solo deploya si el cÃ³digo estÃ¡ verificado
    if: github.ref == 'refs/heads/master'

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Configurar clave SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.GCP_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ Sincronizar cÃ³digo al servidor
        run: |
          rsync -avz \
            --exclude='.git' \
            --exclude='target/' \
            --exclude='logs/' \
            --exclude='trading_state.db' \
            --exclude='.env' \
            --exclude='*.bak' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.GCP_USER }}@${{ secrets.GCP_SERVER_IP }}:~/bot_trading/

      - name: ğŸ”„ Reiniciar el bot en el servidor
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_SERVER_IP }}
          username: ${{ secrets.GCP_USER }}
          key: ${{ secrets.GCP_SSH_KEY }}
          script: |
            set -e
            cd ~/bot_trading

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸï¸  THE CHASSIS â€” Deploy AutomÃ¡tico"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“… Fecha: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "ğŸ“ Commit: ${{ github.sha }}"
            echo "ğŸ‘¤ Autor:  ${{ github.actor }}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Construir y reiniciar con Docker Compose
            echo "ğŸ³ Reconstruyendo imagen Docker..."
            docker compose build --no-cache bot

            echo "ğŸ”„ Reiniciando contenedor..."
            docker compose down
            docker compose up -d

            echo "â³ Esperando que el bot arranque (10s)..."
            sleep 10

            echo "ğŸ“‹ Logs de inicio:"
            docker compose logs --tail=30

            echo ""
            echo "âœ… Deploy completado con Ã©xito!"

      - name: ğŸ“± Notificar en Telegram
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="âœ…"
            MSG="Deploy exitoso"
          else
            EMOJI="âŒ"
            MSG="Deploy FALLIDO"
          fi

          COMMIT_MSG="${{ github.event.head_commit.message }}"
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"

          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="<b>${EMOJI} THE CHASSIS â€” ${MSG}</b>
          <b>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</b>
          <b>â¬¡ Commit:</b> <code>${SHORT_SHA}</code>
          <b>â¬¡ Mensaje:</b> ${COMMIT_MSG}
          <b>â¬¡ Autor:</b> ${{ github.actor }}
          <b>â¬¡ Servidor:</b> GCP (${{ secrets.GCP_SERVER_IP }})

          <i>ğŸ¤– Bot actualizado y corriendo 24/7</i>"
